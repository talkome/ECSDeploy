name: Build and Push to ECR

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: ecr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: self-hosted
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
      ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY || 'ecsdeploy' }}
      CONTAINER_NAME: ${{ vars.CONTAINER_NAME || 'hello-container' }}
      USE_OIDC_ROLE: ${{ secrets.AWS_ROLE_TO_ASSUME != '' }}
      USE_ACCESS_KEYS: ${{ secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify runner dependencies
        shell: bash
        run: |
          set -euo pipefail
          docker --version
          aws --version

      - name: Configure AWS credentials (OIDC)
        if: ${{ env.USE_OIDC_ROLE == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure AWS credentials (access keys)
        if: ${{ env.USE_OIDC_ROLE != 'true' && env.USE_ACCESS_KEYS == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        shell: bash
        run: |
          set -euo pipefail
          AWS_ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "ECR_REGISTRY=${ECR_REGISTRY}" >> "$GITHUB_ENV"
          echo "REPOSITORY_URI=${ECR_REGISTRY}/${ECR_REPOSITORY}" >> "$GITHUB_ENV"
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$ECR_REGISTRY"

      - name: Build, tag, and push image
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_TAG="${GITHUB_SHA::7}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> "$GITHUB_ENV"

          docker build -t "${REPOSITORY_URI}:${IMAGE_TAG}" .
          docker tag "${REPOSITORY_URI}:${IMAGE_TAG}" "${REPOSITORY_URI}:latest"

          docker push "${REPOSITORY_URI}:${IMAGE_TAG}"
          docker push "${REPOSITORY_URI}:latest"

      - name: Write imagedefinitions.json
        shell: bash
        run: |
          set -euo pipefail
          printf '[{"name":"%s","imageUri":"%s"}]' \
            "$CONTAINER_NAME" "${REPOSITORY_URI}:${IMAGE_TAG}" > imagedefinitions.json

      - name: Upload imagedefinitions.json
        uses: actions/upload-artifact@v4
        with:
          name: imagedefinitions
          path: imagedefinitions.json
